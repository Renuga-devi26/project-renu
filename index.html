<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RuralCare Pro ¬∑ complete wellness AI + doctor portal</title>
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: linear-gradient(145deg, #ecf7f1 0%, #f8fffb 100%);
      padding: 28px;
      color: #153e2d;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    /* premium cards */
    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(30, 110, 70, 0.25);
      border-radius: 52px;
      padding: 34px;
      margin-bottom: 30px;
      box-shadow: 0 30px 50px -20px #1b4e3b;
    }

    h2 {
      font-size: 2.2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #166b41, #2a8b5c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 18px;
      border-bottom: 3px solid rgba(30, 110, 70, 0.3);
      padding-bottom: 18px;
    }

    h3 {
      color: #1b6e47;
      font-size: 1.6rem;
      margin: 25px 0 15px;
      display: flex;
      gap: 10px;
    }

    /* language switcher */
    .lang-panel {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .lang-btn {
      background: white;
      border: 2px solid #c0eed5;
      padding: 12px 28px;
      border-radius: 60px;
      font-weight: 600;
      color: #166b41;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .lang-btn.active {
      background: #166b41;
      color: white;
      border-color: #166b41;
      box-shadow: 0 12px 24px rgba(20,90,50,0.4);
    }

    /* input group */
    .input-icon {
      position: relative;
      display: flex;
      align-items: center;
    }
    .input-icon i {
      position: absolute;
      left: 22px;
      color: #267e52;
      font-size: 1.3rem;
    }
    .input-icon input, .input-icon select, .input-icon textarea {
      width: 100%;
      padding: 18px 22px 18px 60px;
      border: 2px solid #d4f0e0;
      border-radius: 60px;
      font-size: 1.05rem;
      background: white;
      transition: 0.2s;
    }
    .input-icon input:focus {
      border-color: #166b41;
      outline: none;
      box-shadow: 0 0 0 5px rgba(30,120,70,0.2);
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    /* VOICE BAR */
    .voice-premium {
      background: linear-gradient(95deg, #dcffe9, #ffffff);
      border-radius: 100px;
      padding: 18px 30px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 25px;
      margin: 30px 0 20px;
      border: 2px solid #a3e2bf;
    }
    .voice-btn {
      background: #166b41;
      color: white;
      border: none;
      padding: 16px 42px;
      border-radius: 80px;
      font-weight: 700;
      font-size: 1.2rem;
      display: flex;
      gap: 14px;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 12px 26px rgba(20,80,40,0.5);
      transition: 0.2s;
    }
    .voice-btn.listening {
      background: #b64545;
      animation: pulse 1.2s infinite;
    }
    .voice-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    @keyframes pulse { 0%{ opacity:1; } 50%{ opacity:0.7; } }
    #voiceStatus {
      font-weight: 600;
      color: #1f5e41;
      font-size: 1.1rem;
    }
    #voiceLangIndicator {
      background: #e9f7ef;
      padding: 10px 22px;
      border-radius: 60px;
      font-weight: 600;
    }

    /* extra symptom */
    .extra-symptom-box {
      background: #ebfcf2;
      border-radius: 70px;
      padding: 22px 32px;
      margin: 20px 0;
      border: 2px solid #7ac9a3;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    .extra-symptom-box input {
      flex: 2;
      min-width: 270px;
      padding: 16px 26px;
      border-radius: 60px;
      border: 2px solid #b1e7ca;
    }

    /* symptom grid */
    .symptom-cat {
      background: rgba(240, 255, 245, 0.6);
      border-radius: 48px;
      padding: 26px;
      margin-bottom: 24px;
    }
    .symptom-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 14px;
    }
    .symptom-item {
      background: white;
      border-radius: 60px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      border: 1px solid #c4f0d7;
    }
    .symptom-item input[type="checkbox"] {
      width: 22px; height: 22px; accent-color: #166b41;
    }

    .btn-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin: 30px 0;
    }
    .btn-primary, .btn-secondary, .btn-danger {
      padding: 18px 42px;
      border-radius: 80px;
      font-weight: 700;
      font-size: 1.2rem;
      border: none;
      cursor: pointer;
      display: inline-flex;
      gap: 14px;
      box-shadow: 0 16px 32px rgba(10,60,30,0.3);
    }
    .btn-primary { background: #166b41; color: white; }
    .btn-secondary { background: #e3f5ea; color: #166b41; }
    .btn-danger { background: #b64545; color: white; }

    .result-premium {
      background: #f6fffa;
      border-radius: 52px;
      padding: 36px;
      border: 1px solid #b3e7cc;
    }
    .status-emergency { color: #b02b2b; font-weight: 800; font-size: 2.2rem; }
    .status-followup { color: #c96b0b; font-weight: 800; font-size: 2.2rem; }
    .status-healthy { color: #166b41; font-weight: 800; font-size: 2.2rem; }

    .recommendation-item {
      background: #f2fcf5;
      border-radius: 50px;
      padding: 18px 28px;
      margin: 12px 0;
      border-left: 12px solid #166b41;
    }
    .food-tip {
      background: #fff4e0;
      border-left-color: #e68a2e;
    }
    .sleep-tip {
      background: #e0f0fd;
      border-left-color: #2e5f8a;
    }

    /* Doctor link (hidden at bottom) */
    .doctor-link-container {
      text-align: center;
      margin: 40px 0 20px;
    }
    .doctor-trigger {
      background: none;
      border: none;
      color: #2a6b4a;
      font-size: 1rem;
      text-decoration: underline;
      cursor: pointer;
      opacity: 0.7;
    }
    .doctor-trigger:hover {
      opacity: 1;
      color: #0a3b2a;
    }

    /* Doctor panel (hidden by default, shown via login) */
    #doctorSection {
      display: none;
      margin-top: 30px;
    }
    .doctor-card {
      background: #e4f1f5;
      border-left: 12px solid #11577a;
    }
    .doctor-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 40px;
      overflow: hidden;
    }
    .doctor-table th { background: #11577a; color: white; padding: 16px; }
    .doctor-table td { padding: 14px; border-bottom: 1px solid #c1ead6; }

    .hidden { display: none; }
    .loader {
      display: none;
      text-align: center;
      padding: 40px;
    }
    .loader-spinner {
      border: 8px solid #daf5e4;
      border-top: 8px solid #166b41;
      border-radius: 50%;
      width: 70px; height: 70px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin { 0%{ transform:rotate(0); } 100%{ transform:rotate(360deg); } }
    #results { display: none; }
  </style>
</head>
<body>
<div class="container">

  <!-- language panel -->
  <div class="lang-panel">
    <button class="lang-btn active" onclick="switchLang('en')"><i class="fas fa-globe"></i> English</button>
    <button class="lang-btn" onclick="switchLang('hi')"><i class="fas fa-language"></i> ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
    <button class="lang-btn" onclick="switchLang('te')"><i class="fas fa-language"></i> ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
    <button class="lang-btn" onclick="switchLang('ta')"><i class="fas fa-language"></i> ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
    <button class="lang-btn" onclick="switchLang('bn')"><i class="fas fa-language"></i> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
  </div>

  <!-- patient card -->
  <div class="card">
    <h2><i class="fas fa-id-card"></i> <span data-i18n="patient">Patient health profile</span></h2>
    <div class="grid-4">
      <div class="input-icon"><i class="fas fa-user"></i><input type="text" id="patientName" placeholder="Full name" value="Sunita Devi"></div>
      <div class="input-icon"><i class="fas fa-calendar-alt"></i><input type="number" id="patientAge" placeholder="Age" value="52"></div>
      <div class="input-icon"><i class="fas fa-venus-mars"></i><select id="patientGender"><option>Male</option><option selected>Female</option><option>Other</option></select></div>
      <div class="input-icon"><i class="fas fa-ruler-vertical"></i><input type="number" id="height" placeholder="Height (cm)" value="160"></div>
      <div class="input-icon"><i class="fas fa-weight-scale"></i><input type="number" id="weight" placeholder="Weight (kg)" value="68"></div>
      <div class="input-icon"><i class="fas fa-thermometer-half"></i><input type="number" step="0.1" id="temperature" placeholder="Temp ¬∞C" value="38.6"></div>
      <div class="input-icon"><i class="fas fa-heartbeat"></i><input type="text" id="bp" placeholder="BP (e.g., 140/90)" value="142/88"></div>
    </div>

    <!-- WORKING VOICE SECTION -->
    <div class="voice-premium">
      <button class="voice-btn" id="voiceBtn" onclick="startVoiceRecognition()"><i class="fas fa-microphone-alt"></i> <span id="voiceBtnText">üé§ Voice input</span></button>
      <span id="voiceStatus"><i class="fas fa-info-circle"></i> Click and speak in your language</span>
      <span id="voiceLangIndicator">üåê English mode</span>
    </div>

    <!-- extra symptom (unlisted) -->
    <div class="extra-symptom-box">
      <i class="fas fa-pen-to-square"></i>
      <span style="font-weight:600; font-size:1.2rem;" data-i18n="extra_note">Symptom not listed? describe here:</span>
      <input type="text" id="freeSymptomInput" placeholder="e.g., tingling, numbness, burning..." value="occasional tingling in left arm">
      <button class="btn-secondary" onclick="addFreeSymptom()" style="padding:14px 28px;"><i class="fas fa-plus-circle"></i> <span data-i18n="add">Add</span></button>
    </div>
  </div>

  <!-- symptoms card -->
  <div class="card">
    <h2><i class="fas fa-stethoscope"></i> <span data-i18n="symptom_checker">Symptom checker</span></h2>
    <div class="input-icon" style="margin-bottom:20px;"><i class="fas fa-search"></i><input type="text" id="symptomSearch" placeholder="filter symptoms..." onkeyup="filterSymptoms()"></div>

    <div class="symptom-cat"><h3><i class="fas fa-temperature-high"></i> General</h3><div class="symptom-grid">
      <div class="symptom-item"><input type="checkbox" id="fever"><label data-i18n="fever">Fever</label></div>
      <div class="symptom-item"><input type="checkbox" id="chills"><label data-i18n="chills">Chills</label></div>
      <div class="symptom-item"><input type="checkbox" id="fatigue"><label data-i18n="fatigue">Fatigue</label></div>
    </div></div>

    <div class="symptom-cat"><h3><i class="fas fa-lungs"></i> Respiratory</h3><div class="symptom-grid">
      <div class="symptom-item"><input type="checkbox" id="cough"><label data-i18n="cough">Cough</label></div>
      <div class="symptom-item"><input type="checkbox" id="dryCough"><label data-i18n="dryCough">Dry cough</label></div>
      <div class="symptom-item"><input type="checkbox" id="wetCough"><label data-i18n="wetCough">Wet cough</label></div>
      <div class="symptom-item"><input type="checkbox" id="bloodCough"><label data-i18n="bloodCough">Blood cough</label></div>
      <div class="symptom-item"><input type="checkbox" id="shortnessBreath"><label data-i18n="shortBreath">Short of breath</label></div>
      <div class="symptom-item"><input type="checkbox" id="chestPain"><label data-i18n="chestPain">Chest pain</label></div>
    </div></div>

    <div class="symptom-cat"><h3><i class="fas fa-stomach"></i> Gastro</h3><div class="symptom-grid">
      <div class="symptom-item"><input type="checkbox" id="nausea"><label data-i18n="nausea">Nausea</label></div>
      <div class="symptom-item"><input type="checkbox" id="vomiting"><label data-i18n="vomiting">Vomiting</label></div>
      <div class="symptom-item"><input type="checkbox" id="diarrhea"><label data-i18n="diarrhea">Diarrhea</label></div>
      <div class="symptom-item"><input type="checkbox" id="abdominalPain"><label data-i18n="abdominalPain">Abdominal pain</label></div>
    </div></div>

    <div class="symptom-cat"><h3><i class="fas fa-brain"></i> Neuro</h3><div class="symptom-grid">
      <div class="symptom-item"><input type="checkbox" id="headache"><label data-i18n="headache">Headache</label></div>
      <div class="symptom-item"><input type="checkbox" id="dizziness"><label data-i18n="dizziness">Dizziness</label></div>
      <div class="symptom-item"><input type="checkbox" id="fainting"><label data-i18n="fainting">Fainting</label></div>
      <div class="symptom-item"><input type="checkbox" id="confusion"><label data-i18n="confusion">Confusion</label></div>
    </div></div>
  </div>

  <!-- buttons -->
  <div class="btn-group">
    <button class="btn-primary" onclick="analyzeHealth()"><i class="fas fa-microchip"></i> <span data-i18n="analyze">Run AI analysis</span></button>
    <button class="btn-secondary" onclick="clearForm()"><i class="fas fa-undo-alt"></i> <span data-i18n="clear">Reset</span></button>
    <button class="btn-danger" onclick="emergencyOverride()"><i class="fas fa-exclamation-triangle"></i> <span data-i18n="emergency">SOS emergency</span></button>
  </div>

  <!-- loader -->
  <div id="loader" class="loader"><div class="loader-spinner"></div><p style="font-size:1.3rem;" data-i18n="analyzing">AI analyzing with deep wellness insights...</p></div>

  <!-- results (now with food, sleep, lifestyle tips) -->
  <div id="results" class="card">
    <h2><i class="fas fa-file-waveform"></i> <span data-i18n="report">AI wellness report</span></h2>
    <div id="emergencyAlert" style="display:none; background:#ffefed; border-radius:48px; padding:28px; border:3px solid #b13e3e; margin-bottom:22px;">
      <span style="color:#b13e3e; font-size:2rem; font-weight:800;"><i class="fas fa-exclamation"></i> EMERGENCY</span>
      <p id="emergencyMessage"></p>
    </div>
    <div class="result-premium">
      <p id="statusText" style="margin-bottom:14px;"></p>
      <p id="description" style="font-size:1.3rem;"></p>
    </div>
    <div style="background:#f2faf5; border-radius:40px; padding:26px; margin:25px 0;">
      <h3><i class="fas fa-clipboard-list"></i> <span data-i18n="your_symptoms">Your symptoms</span></h3>
      <div id="symptomList" style="line-height:2;"></div>
    </div>
    
    <!-- Detailed recommendations now include food, sleep, lifestyle -->
    <h3><i class="fas fa-utensils"></i> üçé Food & nutrition tips</h3>
    <div id="foodTips" style="margin-bottom:20px;"></div>
    
    <h3><i class="fas fa-bed"></i> üò¥ Sleep & rest advice</h3>
    <div id="sleepTips" style="margin-bottom:20px;"></div>
    
    <h3><i class="fas fa-heart"></i> üí™ Lifestyle & home care</h3>
    <div id="solutionsList"></div>
    
    <div style="background:#e0f3e6; border-radius:60px; padding:22px; margin-top:28px; font-weight:600;" id="followUp"></div>
  </div>

  <!-- public history (stays visible) -->
  <div class="card">
    <h2><i class="fas fa-clock-rotate-left"></i> <span data-i18n="recent">Last consultations</span></h2>
    <table style="width:100%; border-collapse:collapse; background:white; border-radius:32px; overflow:hidden;">
      <thead style="background:#166b41; color:white;"><tr><th>Time</th><th>Name</th><th>Age</th><th>Diagnosis</th><th>Status</th></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- üîó HIDDEN DOCTOR LINK (at bottom) - click to show portal -->
  <div class="doctor-link-container">
    <button class="doctor-trigger" onclick="toggleDoctorSection()"><i class="fas fa-user-md"></i> Doctor's portal (secure access)</button>
  </div>

  <!-- üë®‚Äç‚öïÔ∏è DOCTOR SECTION (hidden by default, appears after clicking link) -->
  <div id="doctorSection">
    <div class="card doctor-card">
      <h2><i class="fas fa-user-md"></i> <span>Doctor‚Äôs secure panel</span></h2>
      <div id="doctorLoginBox" style="background:white; border-radius:48px; padding:36px; max-width:460px; margin:0 auto;">
        <p style="font-weight:600; margin-bottom:20px;"><i class="fas fa-lock"></i> Doctor login (demo: doctor/123)</p>
        <div class="input-icon"><i class="fas fa-user-md"></i><input type="text" id="docUser" placeholder="Username" value="doctor"></div>
        <div class="input-icon" style="margin:16px 0;"><i class="fas fa-key"></i><input type="password" id="docPass" placeholder="Password" value="123"></div>
        <button class="btn-primary" onclick="doctorLogin()" style="width:100%;"><i class="fas fa-sign-in-alt"></i> Access all records</button>
      </div>
      <div id="doctorRecords" class="hidden" style="margin-top:28px;">
        <div style="display:flex; justify-content:space-between;">
          <h3><i class="fas fa-database"></i> Complete patient history</h3>
          <button class="btn-secondary" onclick="logoutDoctor()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
        <table class="doctor-table">
          <thead><tr><th>Time</th><th>Name</th><th>Age</th><th>Diagnosis</th><th>Status</th></tr></thead>
          <tbody id="doctorTableBody"></tbody>
        </table>
        <div style="margin-top:20px;">
          <h4>Doctor's recommendations for selected patient:</h4>
          <textarea id="doctorRecommendation" placeholder="Write advice, prescriptions, follow-up..." rows="3" style="width:100%; padding:16px; border-radius:40px; border:2px solid #b1e7ca;"></textarea>
          <button class="btn-primary" style="margin-top:12px;" onclick="sendDoctorAdvice()">Send advice to patient</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ---------- GLOBAL DATA ----------
  let screenings = JSON.parse(localStorage.getItem('ruralWellnessAI') || '[]');
  let currentLang = 'en';
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  let isListening = false;

  // i18n dictionary (simplified)
  const i18n = {
    en: { fever:'Fever', chills:'Chills', fatigue:'Fatigue', cough:'Cough', dryCough:'Dry cough', wetCough:'Wet cough', bloodCough:'Blood cough', shortBreath:'Short of breath', chestPain:'Chest pain', nausea:'Nausea', vomiting:'Vomiting', diarrhea:'Diarrhea', abdominalPain:'Abdominal pain', headache:'Headache', dizziness:'Dizziness', fainting:'Fainting', confusion:'Confusion', analyze:'Run AI analysis', clear:'Reset', emergency:'SOS emergency', analyzing:'AI analyzing...', report:'AI wellness report', your_symptoms:'Your symptoms', solutions:'Lifestyle tips', doctor_panel:'Doctor panel', extra_note:'Symptom not listed?', add:'Add' },
    hi: { fever:'‡§¨‡•Å‡§ñ‡§æ‡§∞', chills:'‡§†‡§Ç‡§° ‡§≤‡§ó‡§®‡§æ', fatigue:'‡§•‡§ï‡§æ‡§®', cough:'‡§ñ‡§æ‡§Ç‡§∏‡•Ä', dryCough:'‡§∏‡•Ç‡§ñ‡•Ä ‡§ñ‡§æ‡§Ç‡§∏‡•Ä', wetCough:'‡§ó‡•Ä‡§≤‡•Ä ‡§ñ‡§æ‡§Ç‡§∏‡•Ä', bloodCough:'‡§ñ‡•Ç‡§® ‡§µ‡§æ‡§≤‡•Ä ‡§ñ‡§æ‡§Ç‡§∏‡•Ä', shortBreath:'‡§∏‡§æ‡§Ç‡§∏ ‡§´‡•Ç‡§≤‡§®‡§æ', chestPain:'‡§∏‡•Ä‡§®‡•á ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§¶', nausea:'‡§Æ‡§§‡§≤‡•Ä', vomiting:'‡§â‡§≤‡•ç‡§ü‡•Ä', diarrhea:'‡§¶‡§∏‡•ç‡§§', abdominalPain:'‡§™‡•á‡§ü ‡§¶‡§∞‡•ç‡§¶', headache:'‡§∏‡§ø‡§∞‡§¶‡§∞‡•ç‡§¶', dizziness:'‡§ö‡§ï‡•ç‡§ï‡§∞', fainting:'‡§¨‡•á‡§π‡•ã‡§∂‡•Ä', confusion:'‡§≠‡•ç‡§∞‡§Æ', analyze:'AI ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£', clear:'‡§∞‡•Ä‡§∏‡•á‡§ü', emergency:'‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤', analyzing:'AI ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£...', report:'AI ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü', your_symptoms:'‡§Ü‡§™‡§ï‡•á ‡§≤‡§ï‡•ç‡§∑‡§£', solutions:'‡§∏‡•Å‡§ù‡§æ‡§µ', doctor_panel:'‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§™‡•à‡§®‡§≤', extra_note:'‡§≤‡§ï‡•ç‡§∑‡§£ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à?', add:'‡§ú‡•ã‡§°‡§º‡•á‡§Ç' }
  };

  function switchLang(lang) {
    currentLang = lang;
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('voiceLangIndicator').innerText = lang==='en'?'üá¨üáß English':lang==='hi'?'üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä':lang==='te'?'üáÆüá≥ ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å':lang==='ta'?'üáÆüá≥ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç':'üáÆüá≥ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ';
    document.querySelectorAll('[data-i18n]').forEach(el => {
      let key = el.getAttribute('data-i18n');
      if(i18n[lang] && i18n[lang][key]) el.innerText = i18n[lang][key];
    });
  }

  // VOICE RECOGNITION
  function startVoiceRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert('Voice not supported in this browser. Please use Chrome, Edge, or Safari.');
      return;
    }
    const btn = document.getElementById('voiceBtn');
    if (isListening) { recognition.stop(); return; }
    recognition.lang = currentLang === 'en' ? 'en-IN' : currentLang === 'hi' ? 'hi-IN' : currentLang === 'te' ? 'te-IN' : currentLang === 'ta' ? 'ta-IN' : 'bn-IN';
    recognition.continuous = false; recognition.interimResults = false;
    btn.classList.add('listening'); btn.disabled = true;
    document.getElementById('voiceStatus').innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Listening... speak now';
    isListening = true;
    recognition.start();

    recognition.onresult = (event) => {
      const speechText = event.results[0][0].transcript.toLowerCase();
      document.getElementById('voiceStatus').innerHTML = `‚úÖ You said: "${speechText}"`;
      if (speechText.includes('fever') || speechText.includes('‡§¨‡•Å‡§ñ‡§æ‡§∞')) document.getElementById('fever').checked = true;
      if (speechText.includes('cough') || speechText.includes('‡§ñ‡§æ‡§Ç‡§∏‡•Ä')) document.getElementById('cough').checked = true;
      if (speechText.includes('headache') || speechText.includes('‡§∏‡§ø‡§∞‡§¶‡§∞‡•ç‡§¶')) document.getElementById('headache').checked = true;
      if (speechText.includes('chest pain') || speechText.includes('‡§∏‡•Ä‡§®‡•á ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§¶')) document.getElementById('chestPain').checked = true;
    };
    recognition.onerror = () => { document.getElementById('voiceStatus').innerHTML = '‚ùå Error'; resetVoice(); };
    recognition.onend = resetVoice;
  }
  function resetVoice() {
    document.getElementById('voiceBtn').classList.remove('listening');
    document.getElementById('voiceBtn').disabled = false;
    isListening = false;
  }
  function addFreeSymptom() { alert('Free symptom will be considered in analysis'); }
  function filterSymptoms() {
    let val = document.getElementById('symptomSearch').value.toLowerCase();
    document.querySelectorAll('.symptom-item').forEach(e => {
      let txt = e.querySelector('label').innerText.toLowerCase();
      e.style.display = txt.includes(val) || val === '' ? 'flex' : 'none';
    });
  }
  function clearForm() {
    document.querySelectorAll('input:not([type=checkbox]), textarea').forEach(e => e.value='');
    document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked=false);
    document.getElementById('results').style.display='none';
    document.getElementById('emergencyAlert').style.display='none';
    filterSymptoms();
  }
  function emergencyOverride() {
    let name = document.getElementById('patientName').value || 'Unknown';
    let age = document.getElementById('patientAge').value || '?';
    document.getElementById('loader').style.display='block';
    document.getElementById('results').style.display='none';
    setTimeout(() => {
      document.getElementById('loader').style.display='none';
      let res = { status:'emergency', statusText:'üö® EMERGENCY', diagnosis:'CRITICAL ALERT', description:'Immediate hospital transfer required.', solutions:['üöë call 108/102 now','üõå keep patient still','‚ùå no oral intake'], symptoms:'emergency override', followUp:'URGENT ‚Äì emergency care' };
      displayResults(res); saveScreening(name,age,res);
    },800);
  }

  function getSelectedSymptoms() {
    const map = { fever:'Fever', chills:'Chills', fatigue:'Fatigue', cough:'Cough', dryCough:'Dry cough', wetCough:'Wet cough', bloodCough:'Blood cough', shortnessBreath:'Shortness of breath', chestPain:'Chest pain', nausea:'Nausea', vomiting:'Vomiting', diarrhea:'Diarrhea', abdominalPain:'Abdominal pain', headache:'Headache', dizziness:'Dizziness', fainting:'Fainting', confusion:'Confusion' };
    return Object.keys(map).filter(id => document.getElementById(id)?.checked).map(id => map[id]);
  }

  // üß† ENHANCED AI with FOOD, SLEEP, LIFESTYLE tips
  function getAIDiagnosis(symptoms, age, temp, bp, freeText) {
    if (symptoms.includes('Chest pain') || symptoms.includes('Blood cough') || symptoms.includes('Fainting') || symptoms.includes('Confusion')) 
      return { emergency:true, message:'High risk symptom ‚Äì urgent', diagnosis:'EMERGENCY ‚Äì URGENT CARE', solutions:['Call ambulance','Hospital now'], food:[], sleep:[] };
    if (temp > 39.5 && symptoms.includes('Confusion')) 
      return { emergency:true, message:'Hyperthermia with confusion', diagnosis:'EMERGENCY ‚Äì SEVERE INFECTION', solutions:['Immediate hospital','Cooling measures'], food:[], sleep:[] };
    
    let diagnosis = '', solutions = [], foodTips = [], sleepTips = [];
    
    if (symptoms.includes('Fever') && symptoms.includes('Cough') && age > 50) {
      diagnosis = 'Viral fever with age risk';
      solutions = ['Monitor BP', 'Keep warm', 'Avoid exertion'];
      foodTips = ['Warm soups (chicken/vegetable)', 'Herbal tea with honey', 'Light khichdi', 'Avoid cold drinks'];
      sleepTips = ['Elevate head while sleeping', 'Take short naps', 'Rest in well-ventilated room', 'Try to sleep 8 hours'];
    }
    else if (symptoms.includes('Fever') && symptoms.includes('Cough') && age <= 30) {
      diagnosis = 'Common cold / viral';
      solutions = ['Steam inhalation', 'Warm water gargle', 'Rest'];
      foodTips = ['Ginger tea', 'Hot milk with turmeric', 'Fresh fruits', 'Avoid fried food'];
      sleepTips = ['Take adequate rest', 'Sleep with extra pillow', 'Keep room humidified'];
    }
    else if (symptoms.includes('Wet cough') && symptoms.includes('Fever')) {
      diagnosis = 'Acute bronchitis';
      solutions = ['Steam 3-4 times daily', 'Avoid smoke', 'Consult if worsens'];
      foodTips = ['Warm turmeric milk', 'Honey with lukewarm water', 'Light dal rice', 'Avoid dairy if mucus increases'];
      sleepTips = ['Sleep on side', 'Keep head elevated', 'Rest in clean air'];
    }
    else if (symptoms.includes('Diarrhea') && symptoms.includes('Vomiting') && age < 10) {
      diagnosis = 'Pediatric gastroenteritis';
      solutions = ['ORS frequently', 'Zinc supplements', 'Monitor urine'];
      foodTips = ['Banana mashed', 'Rice gruel', 'Apple sauce', 'Avoid milk products'];
      sleepTips = ['Let child sleep as needed', 'Keep cool', 'Quiet environment'];
    }
    else if (symptoms.includes('Headache') && symptoms.includes('Dizziness') && bp.includes('140')) {
      diagnosis = 'BP fluctuation';
      solutions = ['Monitor BP twice daily', 'Reduce salt', 'Light walking'];
      foodTips = ['Less salt', 'Fresh vegetables', 'Avoid pickles', 'Coconut water'];
      sleepTips = ['Sleep 7-8 hours', 'Avoid screen before bed', 'Dark quiet room'];
    }
    else if (freeText && freeText.toLowerCase().includes('tingling')) {
      diagnosis = 'Neuropathic sensation';
      solutions = ['B12 rich foods', 'Neurology consult', 'Gentle stretching'];
      foodTips = ['Spinach', 'Eggs', 'Dairy', 'Fortified cereals'];
      sleepTips = ['Elevate limbs', 'Comfortable mattress', 'Relaxation before bed'];
    }
    else if (symptoms.length === 0) {
      diagnosis = 'No symptoms ‚Äì healthy';
      solutions = ['Regular exercise', 'Stay hydrated', 'Routine checkup'];
      foodTips = ['Eat rainbow fruits/veg', 'Whole grains', 'Nuts & seeds', 'Limit sugar'];
      sleepTips = ['7-9 hours sleep', 'Consistent schedule', 'No phone 1hr before bed'];
    }
    else {
      diagnosis = 'General symptoms';
      solutions = ['Monitor for 2 days', 'Clinic if persists', 'Rest'];
      foodTips = ['Light home-cooked meals', 'Avoid spicy/oily', 'Drink water'];
      sleepTips = ['Take rest', 'Sleep on time', 'Reduce stress'];
    }
    return { emergency:false, diagnosis, solutions, foodTips, sleepTips };
  }

  function analyzeHealth() {
    let name = document.getElementById('patientName').value.trim() || 'Unknown';
    let age = parseInt(document.getElementById('patientAge').value) || 35;
    let temp = parseFloat(document.getElementById('temperature').value) || 36.5;
    let bp = document.getElementById('bp').value || '';
    let freeText = document.getElementById('freeSymptomInput').value;

    document.getElementById('loader').style.display='block';
    document.getElementById('results').style.display='none';

    setTimeout(() => {
      document.getElementById('loader').style.display='none';
      let symptoms = getSelectedSymptoms();
      let analysis = getAIDiagnosis(symptoms, age, temp, bp, freeText);
      let result;
      if (analysis.emergency) {
        result = { status:'emergency', statusText:'üö® EMERGENCY', diagnosis:analysis.diagnosis, description:analysis.message||'Urgent', solutions:analysis.solutions, foodTips:[], sleepTips:[], symptoms:symptoms.join(', ')+(freeText? ' + note: "'+freeText+'"':''), followUp:'IMMEDIATE CARE' };
      } else {
        result = { status:symptoms.length?'followup':'healthy', statusText:symptoms.length?'‚ö†Ô∏è Needs attention':'‚úÖ Healthy', diagnosis:analysis.diagnosis, description:'Personalized wellness plan below.', solutions:analysis.solutions, foodTips:analysis.foodTips || [], sleepTips:analysis.sleepTips || [], symptoms:symptoms.join(', ')+(freeText? ' + "'+freeText+'"':''), followUp:symptoms.length?'review in 2-3 days':'regular checkup' };
      }
      displayResults(result);
      saveScreening(name, age, result);
    }, 1400);
  }

  function displayResults(r) {
    document.getElementById('results').style.display='block';
    let cls = r.status==='emergency'?'status-emergency':r.status==='followup'?'status-followup':'status-healthy';
    document.getElementById('statusText').innerHTML = `<span class="${cls}">${r.statusText}</span>`;
    document.getElementById('description').innerText = r.description;
    let sym = r.symptoms; let symHtml='';
    if(sym && sym!=='none') sym.split(', ').forEach(s=>symHtml+=`<span style="background:#e6f4ea; padding:8px 22px; border-radius:60px; margin:5px; display:inline-block;">${s}</span> `);
    else symHtml = 'none';
    document.getElementById('symptomList').innerHTML = symHtml;

    // food tips
    let foodHtml = ''; (r.foodTips || []).forEach(f => foodHtml+=`<div class="recommendation-item food-tip"><i class="fas fa-apple-alt"></i> ${f}</div>`);
    document.getElementById('foodTips').innerHTML = foodHtml || '<div class="recommendation-item">General healthy eating</div>';
    // sleep tips
    let sleepHtml = ''; (r.sleepTips || []).forEach(s => sleepHtml+=`<div class="recommendation-item sleep-tip"><i class="fas fa-moon"></i> ${s}</div>`);
    document.getElementById('sleepTips').innerHTML = sleepHtml || '<div class="recommendation-item">Maintain regular sleep</div>';
    // lifestyle
    let solHtml=''; (r.solutions || []).forEach(s => solHtml+=`<div class="recommendation-item"><i class="fas fa-heart"></i> ${s}</div>`);
    document.getElementById('solutionsList').innerHTML = solHtml;
    document.getElementById('followUp').innerHTML = `<i class="fas fa-clock"></i> ${r.followUp}`;
    if(r.status==='emergency') { 
      document.getElementById('emergencyAlert').style.display='block'; 
      document.getElementById('emergencyMessage').innerText=r.description; 
    } else document.getElementById('emergencyAlert').style.display='none';
  }

  function saveScreening(name, age, result) {
    let rec = { time:new Date().toLocaleString(), name, age, diagnosis:result.diagnosis, status:result.statusText };
    screenings.unshift(rec); if(screenings.length>30) screenings.pop();
    localStorage.setItem('ruralWellnessAI', JSON.stringify(screenings));
    renderTables();
  }

  function renderTables() {
    let tbody = document.getElementById('tableBody');
    let docBody = document.getElementById('doctorTableBody');
    if(!screenings.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">no records</td></tr>';
      if(docBody) docBody.innerHTML = '<tr><td colspan="5">no records</td></tr>';
      return;
    }
    tbody.innerHTML = screenings.map(s => `<tr><td>${s.time}</td><td>${s.name}</td><td>${s.age}</td><td>${s.diagnosis}</td><td>${s.status}</td></tr>`).join('');
    if(docBody) docBody.innerHTML = screenings.map(s => `<tr><td>${s.time}</td><td>${s.name}</td><td>${s.age}</td><td>${s.diagnosis}</td><td>${s.status}</td></tr>`).join('');
  }

  // DOCTOR PORTAL (hidden, appears via link)
  function toggleDoctorSection() {
    let sec = document.getElementById('doctorSection');
    sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
  }
  function doctorLogin() {
    if(document.getElementById('docUser').value === 'doctor' && document.getElementById('docPass').value === '123') {
      document.getElementById('doctorLoginBox').classList.add('hidden');
      document.getElementById('doctorRecords').classList.remove('hidden');
      renderTables();
    } else alert('Invalid (doctor/123)');
  }
  function logoutDoctor() {
    document.getElementById('doctorLoginBox').classList.remove('hidden');
    document.getElementById('doctorRecords').classList.add('hidden');
  }
  function sendDoctorAdvice() {
    let advice = document.getElementById('doctorRecommendation').value;
    if(advice) alert('Advice sent to patient (demo): ' + advice);
  }

  window.onload = function() { renderTables(); switchLang('en'); };
</script>
</body>
</html>
