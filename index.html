from flask import Flask, request, jsonify, render_template_string

app = Flask(__name__)

# =========================
# AI ENGINE (from ai_engine.py)
# =========================
def analyze_patient(age, symptom, bp, sugar):
    risk_score = 0

    if age > 60:
        risk_score += 2

    if symptom.lower() in ["chest pain", "breathing issue"]:
        risk_score += 3

    if bp > 140:
        risk_score += 2

    if sugar > 180:
        risk_score += 2

    if risk_score >= 6:
        return "HIGH RISK – Immediate medical attention required."
    elif risk_score >= 3:
        return "MODERATE RISK – Doctor consultation recommended."
    else:
        return "LOW RISK – Basic monitoring advised."


# =========================
# FULL HTML (index.html + styles.css + main.js merged)
# =========================
HTML_PAGE = """
<!DOCTYPE html>
<html>
<head>
    <title>RuralCare AI - Advanced</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: Arial;
            background: #f4f7fa;
            margin: 0;
        }
        header {
            background: #2e7d32;
            color: white;
            padding: 15px;
            text-align: center;
        }
        .container {
            padding: 20px;
            max-width: 600px;
            margin: auto;
        }
        .card {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }
        button {
            background: #2e7d32;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background: #1b5e20;
        }
        #result {
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>

<header>
    <h2>RuralCare AI – Advanced Screening</h2>
</header>

<div class="container">
    <div class="card">
        <h3>Patient Details</h3>

        <input type="number" id="age" placeholder="Age">

        <select id="symptom">
            <option value="">Select Symptom</option>
            <option>Fever</option>
            <option>Chest Pain</option>
            <option>Breathing Issue</option>
            <option>Cough</option>
        </select>

        <input type="number" id="bp" placeholder="Blood Pressure">
        <input type="number" id="sugar" placeholder="Blood Sugar">

        <button onclick="screenPatient()">Run AI Screening</button>
    </div>

    <div class="card">
        <h3>AI Result</h3>
        <p id="result">No screening yet.</p>
    </div>
</div>

<script>
function screenPatient() {
    const age = document.getElementById("age").value;
    const symptom = document.getElementById("symptom").value;
    const bp = document.getElementById("bp").value;
    const sugar = document.getElementById("sugar").value;

    if (!age || !symptom || !bp || !sugar) {
        alert("Fill all fields.");
        return;
    }

    fetch("/analyze", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            age: parseInt(age),
            symptom: symptom,
            bp: parseInt(bp),
            sugar: parseInt(sugar)
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById("result").innerText = data.result;
    })
    .catch(error => {
        document.getElementById("result").innerText = "Server error.";
    });
}
</script>

</body>
</html>
"""


# =========================
# ROUTES (from app.py)
# =========================
@app.route("/")
def home():
    return render_template_string(HTML_PAGE)


@app.route("/analyze", methods=["POST"])
def analyze():
    try:
        data = request.get_json()

        age = int(data.get("age", 0))
        symptom = data.get("symptom", "")
        bp = int(data.get("bp", 0))
        sugar = int(data.get("sugar", 0))

        if age <= 0 or not symptom:
            return jsonify({"result": "Invalid input."}), 400

        result = analyze_patient(age, symptom, bp, sugar)

        return jsonify({"result": result})

    except Exception:
        return jsonify({"result": "Internal server error."}), 500


# =========================
# RUN
# =========================
if __name__ == "__main__":
    app.run(debug=True)
