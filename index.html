// ==================== server.js - Backend Server ====================
const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const path = require('path');
const fs = require('fs');
const cors = require('cors');
const multer = require('multer');
const sharp = require('sharp');
const crypto = require('crypto');

const app = express();
const PORT = 3000;

// ==================== MIDDLEWARE ====================
app.use(cors());
app.use(express.json({ limit: '100mb' }));
app.use(express.urlencoded({ extended: true, limit: '100mb' }));

// ==================== FILE STORAGE SETUP ====================
const uploadDir = path.join(__dirname, 'uploads');
const patientsDir = path.join(uploadDir, 'patients');
const screeningsDir = path.join(uploadDir, 'screenings');
const thumbnailsDir = path.join(uploadDir, 'thumbnails');
const audioDir = path.join(uploadDir, 'audio');

// Create directories
[uploadDir, patientsDir, screeningsDir, thumbnailsDir, audioDir].forEach(dir => {
    if (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { recursive: true });
    }
});

// Serve static files
app.use('/uploads', express.static(uploadDir));

// ==================== DATABASE SETUP ====================
const db = new sqlite3.Database('./ruralcare.db', (err) => {
    if (err) {
        console.error('Database error:', err);
    } else {
        console.log('âœ… Database connected');
        initializeDatabase();
    }
});

function initializeDatabase() {
    db.serialize(() => {
        // Tamil Nadu Districts table
        db.run(`CREATE TABLE IF NOT EXISTS districts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            district_name TEXT UNIQUE NOT NULL,
            district_code TEXT,
            region TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )`);

        // Patients table
        db.run(`CREATE TABLE IF NOT EXISTS patients (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            patient_id TEXT UNIQUE NOT NULL,
            full_name TEXT NOT NULL,
            age INTEGER NOT NULL,
            gender TEXT,
            district TEXT NOT NULL,
            district_code TEXT,
            contact TEXT,
            photo_path TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            is_active BOOLEAN DEFAULT 1
        )`);

        // Screenings table with voice recording
        db.run(`CREATE TABLE IF NOT EXISTS screenings (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            screening_id TEXT UNIQUE NOT NULL,
            patient_id TEXT NOT NULL,
            patient_name TEXT NOT NULL,
            age INTEGER NOT NULL,
            district TEXT NOT NULL,
            district_code TEXT,
            photo_path TEXT,
            thumbnail_path TEXT,
            audio_path TEXT,
            symptoms_text TEXT,
            symptoms_duration INTEGER,
            prediction TEXT NOT NULL,
            confidence REAL NOT NULL,
            risk_level TEXT,
            recommendations TEXT,
            follow_up_required BOOLEAN DEFAULT 0,
            follow_up_date TEXT,
            notes TEXT,
            asha_worker TEXT,
            device_info TEXT,
            offline_sync BOOLEAN DEFAULT 0,
            synced_at DATETIME,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
        )`);

        // Sync queue for offline data
        db.run(`CREATE TABLE IF NOT EXISTS sync_queue (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            data_type TEXT NOT NULL,
            data_json TEXT NOT NULL,
            status TEXT DEFAULT 'pending',
            retry_count INTEGER DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )`);

        // Insert Tamil Nadu districts
        const districts = [
            { name: 'Ariyalur', code: 'AR', region: 'Central' },
            { name: 'Chengalpattu', code: 'CL', region: 'North' },
            { name: 'Chennai', code: 'CH', region: 'North' },
            { name: 'Coimbatore', code: 'CO', region: 'West' },
            { name: 'Cuddalore', code: 'CU', region: 'North' },
            { name: 'Dharmapuri', code: 'DH', region: 'West' },
            { name: 'Dindigul', code: 'DI', region: 'South' },
            { name: 'Erode', code: 'ER', region: 'West' },
            { name: 'Kallakurichi', code: 'KL', region: 'North' },
            { name: 'Kanchipuram', code: 'KC', region: 'North' },
            { name: 'Kanyakumari', code: 'KK', region: 'South' },
            { name: 'Karur', code: 'KR', region: 'Central' },
            { name: 'Krishnagiri', code: 'KG', region: 'West' },
            { name: 'Madurai', code: 'MD', region: 'South' },
            { name: 'Mayiladuthurai', code: 'MY', region: 'Central' },
            { name: 'Nagapattinam', code: 'NG', region: 'Central' },
            { name: 'Namakkal', code: 'NM', region: 'West' },
            { name: 'Nilgiris', code: 'NI', region: 'West' },
            { name: 'Perambalur', code: 'PE', region: 'Central' },
            { name: 'Pudukkottai', code: 'PU', region: 'Central' },
            { name: 'Ramanathapuram', code: 'RA', region: 'South' },
            { name: 'Ranipet', code: 'RN', region: 'North' },
            { name: 'Salem', code: 'SA', region: 'West' },
            { name: 'Sivaganga', code: 'SI', region: 'South' },
            { name: 'Tenkasi', code: 'TE', region: 'South' },
            { name: 'Thanjavur', code: 'TJ', region: 'Central' },
            { name: 'Theni', code: 'TH', region: 'South' },
            { name: 'Thoothukkudi', code: 'TT', region: 'South' },
            { name: 'Tiruchirappalli', code: 'TC', region: 'Central' },
            { name: 'Tirunelveli', code: 'TI', region: 'South' },
            { name: 'Tirupathur', code: 'TP', region: 'North' },
            { name: 'Tiruppur', code: 'TR', region: 'West' },
            { name: 'Tiruvallur', code: 'TL', region: 'North' },
            { name: 'Tiruvannamalai', code: 'TV', region: 'North' },
            { name: 'Tiruvarur', code: 'TW', region: 'Central' },
            { name: 'Vellore', code: 'VE', region: 'North' },
            { name: 'Viluppuram', code: 'VI', region: 'North' },
            { name: 'Virudhunagar', code: 'VR', region: 'South' }
        ];

        districts.forEach(district => {
            db.run('INSERT OR IGNORE INTO districts (district_name, district_code, region) VALUES (?, ?, ?)', 
                [district.name, district.code, district.region]);
        });

        console.log('âœ… Database tables ready with Tamil Nadu districts');
    });
}

// ==================== MULTER CONFIGURATION ====================
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        if (file.fieldname === 'photo') {
            cb(null, patientsDir);
        } else if (file.fieldname === 'screening_photo') {
            cb(null, screeningsDir);
        } else if (file.fieldname === 'audio') {
            cb(null, audioDir);
        }
    },
    filename: (req, file, cb) => {
        const uniqueId = crypto.randomBytes(16).toString('hex');
        const ext = path.extname(file.originalname);
        cb(null, `${Date.now()}-${uniqueId}${ext}`);
    }
});

const upload = multer({
    storage: storage,
    limits: { fileSize: 50 * 1024 * 1024 },
    fileFilter: (req, file, cb) => {
        if (file.fieldname === 'audio') {
            const allowed = ['audio/webm', 'audio/mp3', 'audio/wav', 'audio/mpeg', 'audio/ogg'];
            if (allowed.includes(file.mimetype)) {
                cb(null, true);
            } else {
                cb(new Error('Invalid audio format'));
            }
        } else {
            const allowed = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (allowed.includes(file.mimetype)) {
                cb(null, true);
            } else {
                cb(new Error('Invalid image format'));
            }
        }
    }
});

// ==================== IMAGE PROCESSING ====================
async function createThumbnail(inputPath, outputPath) {
    try {
        await sharp(inputPath)
            .resize(200, 200, { fit: 'cover' })
            .jpeg({ quality: 70 })
            .toFile(outputPath);
        return outputPath;
    } catch (error) {
        console.error('Thumbnail error:', error);
        return null;
    }
}

// ==================== API ROUTES ====================

// Health check
app.get('/api/health', (req, res) => {
    res.json({ 
        status: 'online', 
        time: new Date(),
        storage: {
            patients: fs.existsSync(patientsDir),
            screenings: fs.existsSync(screeningsDir),
            audio: fs.existsSync(audioDir)
        }
    });
});

// Get Tamil Nadu districts
app.get('/api/districts', (req, res) => {
    db.all('SELECT * FROM districts ORDER BY district_name', [], (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows);
    });
});

// ==================== PATIENT ROUTES ====================

// Create patient
app.post('/api/patients', upload.single('photo'), async (req, res) => {
    try {
        const { patient_id, full_name, age, gender, district, district_code, contact } = req.body;
        
        db.get('SELECT patient_id FROM patients WHERE patient_id = ?', [patient_id], async (err, row) => {
            if (err) return res.status(500).json({ error: err.message });
            if (row) return res.status(400).json({ error: 'Patient ID exists' });

            let photoPath = null;
            if (req.file) {
                photoPath = `/uploads/patients/${req.file.filename}`;
            }

            const sql = `INSERT INTO patients 
                (patient_id, full_name, age, gender, district, district_code, contact, photo_path) 
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)`;

            db.run(sql, [patient_id, full_name, age, gender, district, district_code, contact, photoPath], function(err) {
                if (err) return res.status(500).json({ error: err.message });
                
                res.status(201).json({
                    id: this.lastID,
                    patient_id,
                    photo_path: photoPath,
                    message: 'Patient created'
                });
            });
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// Get all patients
app.get('/api/patients', (req, res) => {
    const { district, page = 1, limit = 50 } = req.query;
    const offset = (page - 1) * limit;
    
    let sql = 'SELECT * FROM patients WHERE is_active = 1';
    let params = [];
    
    if (district) {
        sql += ' AND district = ?';
        params.push(district);
    }
    
    sql += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';
    params.push(parseInt(limit), parseInt(offset));
    
    db.all(sql, params, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows);
    });
});

// Get patient by ID
app.get('/api/patients/:patient_id', (req, res) => {
    db.get('SELECT * FROM patients WHERE patient_id = ?', [req.params.patient_id], (err, row) => {
        if (err) return res.status(500).json({ error: err.message });
        if (!row) return res.status(404).json({ error: 'Patient not found' });
        res.json(row);
    });
});

// ==================== SCREENING ROUTES ====================

// Create screening with photo and audio
app.post('/api/screenings', upload.fields([
    { name: 'photo', maxCount: 1 },
    { name: 'audio', maxCount: 1 }
]), async (req, res) => {
    try {
        const {
            screening_id, patient_id, patient_name, age, district, district_code,
            symptoms_text, symptoms_duration,
            prediction, confidence, risk_level, recommendations,
            follow_up_required, follow_up_date, notes, asha_worker, device_info
        } = req.body;

        let photoPath = null;
        let thumbnailPath = null;
        let audioPath = null;

        if (req.files['photo']) {
            const photoFile = req.files['photo'][0];
            photoPath = `/uploads/screenings/${photoFile.filename}`;
            
            const thumbName = `thumb-${photoFile.filename}`;
            const thumbFullPath = path.join(thumbnailsDir, thumbName);
            await createThumbnail(photoFile.path, thumbFullPath);
            thumbnailPath = `/uploads/thumbnails/${thumbName}`;
        }

        if (req.files['audio']) {
            const audioFile = req.files['audio'][0];
            audioPath = `/uploads/audio/${audioFile.filename}`;
        }

        const sql = `INSERT INTO screenings (
            screening_id, patient_id, patient_name, age, district, district_code,
            photo_path, thumbnail_path, audio_path, symptoms_text, symptoms_duration,
            prediction, confidence, risk_level, recommendations,
            follow_up_required, follow_up_date, notes,
            asha_worker, device_info
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`;

        db.run(sql, [
            screening_id, patient_id, patient_name, age, district, district_code,
            photoPath, thumbnailPath, audioPath, symptoms_text, symptoms_duration,
            prediction, confidence, risk_level, recommendations,
            follow_up_required || 0, follow_up_date, notes,
            asha_worker, device_info
        ], function(err) {
            if (err) return res.status(500).json({ error: err.message });
            
            res.status(201).json({
                id: this.lastID,
                screening_id,
                photo_path: photoPath,
                audio_path: audioPath,
                message: 'Screening saved'
            });
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// Get screenings for patient
app.get('/api/screenings/patient/:patient_id', (req, res) => {
    db.all('SELECT * FROM screenings WHERE patient_id = ? ORDER BY created_at DESC', 
        [req.params.patient_id], (err, rows) => {
            if (err) return res.status(500).json({ error: err.message });
            res.json(rows);
    });
});

// Get recent screenings
app.get('/api/screenings/recent', (req, res) => {
    const { limit = 20 } = req.query;
    db.all('SELECT * FROM screenings ORDER BY created_at DESC LIMIT ?', 
        [parseInt(limit)], (err, rows) => {
            if (err) return res.status(500).json({ error: err.message });
            res.json(rows);
    });
});

// Get audio file
app.get('/api/audio/:filename', (req, res) => {
    const filePath = path.join(audioDir, req.params.filename);
    if (fs.existsSync(filePath)) {
        res.sendFile(filePath);
    } else {
        res.status(404).json({ error: 'Audio not found' });
    }
});

// ==================== SYNC ROUTES ====================

// Upload offline data
app.post('/api/sync/upload', (req, res) => {
    const { data } = req.body;
    
    if (!Array.isArray(data)) {
        return res.status(400).json({ error: 'Data must be an array' });
    }
    
    const stmt = db.prepare('INSERT INTO sync_queue (data_type, data_json) VALUES (?, ?)');
    
    data.forEach(item => {
        stmt.run([item.type || 'screening', JSON.stringify(item)]);
    });
    
    stmt.finalize();
    
    res.json({ message: 'Data queued', count: data.length });
});

// ==================== STATS ROUTES ====================

// Get dashboard stats
app.get('/api/stats/dashboard', (req, res) => {
    const stats = {};
    
    db.get('SELECT COUNT(*) as total FROM patients WHERE is_active = 1', [], (err, row) => {
        stats.totalPatients = row.total;
        
        db.get('SELECT COUNT(*) as total FROM screenings', [], (err, row) => {
            stats.totalScreenings = row.total;
            
            db.get(`SELECT COUNT(*) as total FROM screenings WHERE date(created_at) = date('now')`, [], (err, row) => {
                stats.todayScreenings = row.total;
                
                db.get('SELECT COUNT(*) as total FROM screenings WHERE follow_up_required = 1', [], (err, row) => {
                    stats.followUpsNeeded = row.total;
                    
                    db.all(`SELECT 
                        COUNT(CASE WHEN prediction = 'healthy' THEN 1 END) as healthy,
                        COUNT(CASE WHEN prediction != 'healthy' THEN 1 END) as followup
                        FROM screenings`, [], (err, rows) => {
                        
                        stats.predictionStats = rows[0] || { healthy: 0, followup: 0 };
                        res.json(stats);
                    });
                });
            });
        });
    });
});

// ==================== SEARCH ====================

// Search patients
app.get('/api/search/patients', (req, res) => {
    const { q, district } = req.query;
    
    if (!q) return res.json([]);
    
    let query = `SELECT * FROM patients WHERE 
            (patient_id LIKE ? OR 
            full_name LIKE ?)`;
    let params = [`%${q}%`, `%${q}%`];
    
    if (district) {
        query += ' AND district = ?';
        params.push(district);
    }
    
    query += ' LIMIT 20';
    
    db.all(query, params, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows);
    });
});

// ==================== START SERVER ====================
app.listen(PORT, () => {
    console.log(`âœ… Server running on http://localhost:${PORT}`);
    console.log(`ğŸ“ Uploads: ${uploadDir}`);
    console.log(`ğŸ“Š Database: ruralcare.db`);
    console.log(`ğŸ¤ Audio recordings: ${audioDir}`);
    console.log(`ğŸ“ Tamil Nadu districts loaded: 38 districts`);
});
                
